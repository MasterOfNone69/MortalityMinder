---
title: "State Comparison"
Author: Farukh Saidmuratov 
Date: Oct 16, 2019 
---

# Libraries and Environment
```{r}
set.seed(300)
current.dir <- getwd()

# set working directory to current apps init
path.to.current.app <- file.path("..", "init")
setwd(file.path(path.to.current.app))

source("Librarian.R")
source("Loader_CHR2019.R")
source("Loader_CDC.R")
source("Loader_GEO.R")
source("Analyzer_PCA.R")
source("Clustering_Lib.R")
source("Analyzer_Correlation.R")
source("Theme.R") # for styles for plots 

source("CDC_Lib.R")# For making plot 

# revert to original working directory
current.dir <- getwd()
setwd(current.dir)
```

# Labs line mort for multiple states 
```{r}
labs.line.mort.mult <- function(state.choice1, state.choice2, death.cause) {
  labs(
    title = paste(
      state.choice1, 
      paste("Death of", death.cause, "Trend"), 
      state.choice2, 
      sep = ' - '
    ),
    caption = "Data Sorce: CDCWONDER Multi-Cause of Death",
    x = "Period", y = "Mortality Rate (# per 100k)"
  )
}
```

# Parameters. Set first state to be Mass., and second state to be Connecticut Explore difference between deaths of cardiovascular disease.
```{r}
death.causes <- c("Despair","Cancer","Assault","Cardiovascular")
input <- list(state_choice1 = state.abb[21], state_choice2 = state.abb[7], 
              death_cause = death.causes[4])
```

# Compare the mortality trends of Mass. and CT 2 New England states, where MA has Affordable Health Care
# Act type policies, while CT doesn't 

# State data raw 
```{r}
mort.state.raw <- function() {
  # Variables:
  #   - county_fips
  rbind(cdc.data %>%
    cdc.mort.mat(input$state_choice1, input$death_cause), cdc.data %>%
    cdc.mort.mat(input$state_choice2, input$death_cause))
}
```

# Run 
```{r}
mort.state.raw()
```

## Cache of Weighed Avg by UNORDERED cluster (for states)

* The cluster labels are UNORDERED
```{r}
mort.avg.state.raw <- function() {

  # Variables:
  #   - period
  #   - cluster
  #   - death_rate
  #   - count
  cdc.data %>%
    dplyr::filter((state_abbr == input$state_choice1 | state_abbr == input$state_choice2), death_cause == input$death_cause) %>%
    dplyr::right_join(mort.state.raw(), by = "county_fips") %>%
    dplyr::group_by(period, state_abbr) %>%
    dplyr::summarise(
      death_rate = sum(death_num) / sum(population) * 10^5,
      count = n()
    ) %>%
    dplyr::ungroup()
}
```

# Run 
```{r}
mort.avg.state.raw()
```

## Cache of MAPPING from UNORDERED mortality trend label to ORDERED mortality trend label

* This is a mapping from raw cluster label to ORDERED cluster.
* Row names are the original cluster and `ord` are the reordered cluster
```{r}
mort.state.map <- function() {
  # Variables:
  #   - ord
  mort.avg.state.raw() %>%
    dplyr::filter(period == "2015-2017") %>%
    dplyr::arrange(death_rate) %>%
    dplyr::mutate(ord = as.character(1:n())) %>%
    dplyr::select(-c(period, death_rate)) %>%
    textshape::column_to_rownames("state_abbr")
}
```

## Cache of ORDERED mortality trend state label calculation

```{r}
mort.state.ord <- function() {
  # Variables:
  #   - county_fips
  #   - state_abbr
  dplyr::mutate(mort.state.raw(), state_abbr = mort.state.map()[state_abbr, "ord"])
}
```

## Cache of Weighed Avg by ORDERED state

* The cluster labels are ORDERED
```{r}
mort.avg.state.ord <- function() {
  # Variables:
  #   - period
  #   - state
  #   - death_rate
  #   - count

  dplyr::mutate(mort.avg.state.raw(), state_abbr = mort.state.map()[state_abbr, "ord"])
}
```


# Consider 2 states as 2 different "clusters"
```{r}
color.line.cluster <- function(state.choice, n.clusters) {
  
  if (state.choice != "US"){
    scale_color_manual(
      name = "Cluster",
      #c("#ffc4c4", "#ff8f8f", "#ff5454", "#ff1414", "#a80000")
      values = colorRampPalette(
        c("#feedde", "#fdd0a2", "#fdae6b", "#fd8d3c", "#e6550d", "#a63603")
        
      )(n.clusters),
      guide = guide_legend(reverse = T)
    )
    
  } else {
    scale_color_manual(
      name = "State",
      #c("#ffc4c4", "#ff8f8f", "#ff5454", "#ff1414", "#a80000")
      values = colorRampPalette(
        c("#fef0d9","#fdcc8a","#fc8d59","#e34a33")
        
      )(n.clusters),
      guide = guide_legend(reverse = T)
    )
  }
  
}
```


# Function to plot comparison between states. Change font family because of bug on my machine. 
```{r}
library(extrafont)
loadfonts(quiet = T)

plot_mort_line <- function() {
  ggplot(mort.avg.state.ord(), aes(x = period, y = death_rate,color = state_abbr, group = state_abbr)) + geom_line(size = 1) + geom_point(color = "black", shape = 21, fill = "white") + labs.line.mort.mult(input$state_choice1, input$state_choice2, input$death_cause) + color.line.cluster(input$state_choice1, 2) + theme.line.mort() + guides(color = guide_legend(reverse = T)) + theme(text=element_text(family="Arial Black"))
}
```

# Plot!
```{r}
plot_mort_line()
```


